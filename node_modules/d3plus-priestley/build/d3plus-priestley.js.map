{"version":3,"file":"d3plus-priestley.js","sources":["../src/Priestley.js"],"sourcesContent":["/**\n    @external Viz\n    @see https://github.com/d3plus/d3plus-viz#Viz\n*/\n\nimport {min, max, range} from \"d3-array\";\nimport {nest} from \"d3-collection\";\nimport {scalePoint} from \"d3-scale\";\n\nimport {Axis, date} from \"d3plus-axis\";\nimport {accessor, assign, configPrep, elem} from \"d3plus-common\";\nimport {Rect} from \"d3plus-shape\";\nimport {Viz} from \"d3plus-viz\";\n\n/**\n    @class Priestley\n    @extends external:Viz\n    @desc Creates a priestley timeline based on an array of data.\n*/\nexport default class Priestley extends Viz {\n\n  /**\n      @memberof Priestley\n      @desc Invoked when creating a new class instance, and sets any default parameters.\n      @private\n  */\n  constructor() {\n\n    super();\n\n    this._axis = new Axis().align(\"end\").orient(\"bottom\");\n    this._axisConfig = {scale: \"time\"};\n    this._axisTest = new Axis().align(\"end\").gridSize(0).orient(\"bottom\");\n    this.end(\"end\");\n    this._shapeConfig = assign({}, this._shapeConfig, {\n      ariaLabel: (d, i) => `${this._drawLabel(d, i)}, ${this._start(d, i)} - ${this._end(d, i)}.`\n    });\n    this.start(\"start\");\n\n  }\n\n  /**\n      @memberof Priestley\n      @desc Extends the render behavior of the abstract Viz class.\n      @private\n  */\n  render(callback) {\n\n    super.render(callback);\n\n    if (!this._filteredData) return this;\n\n    const data = this._filteredData.map((data, i) => ({\n      __d3plus__: true,\n      data,\n      end: this._axisConfig.scale === \"time\" ? date(this._end(data, i)) : this._end(data, i),\n      i,\n      id: this._id(data, i),\n      start: this._axisConfig.scale === \"time\" ? date(this._start(data, i)) : this._start(data, i)\n    })).filter(d => d.end - d.start > 0).sort((a, b) => a.start - b.start);\n\n    let nestedData;\n    if (this._groupBy.length > 1 && this._drawDepth > 0) {\n      const dataNest = nest();\n      for (let i = 0; i < this._drawDepth; i++) dataNest.key(d => this._groupBy[i](d.data, d.i));\n      nestedData = dataNest.entries(data);\n    }\n    else nestedData = [{values: data}];\n\n    let maxLane = 0;\n    nestedData.forEach(g => {\n      let track = [];\n      g.values.forEach(d => {\n        track = track.map(t => t <= d.start ? false : t);\n        const i = track.indexOf(false);\n        if (i < 0) {\n          d.lane = maxLane + track.length;\n          track.push(d.end);\n        }\n        else {\n          track[i] = d.end;\n          d.lane = maxLane + i;\n        }\n      });\n      maxLane += track.length;\n    });\n\n    const axisConfig = {\n      domain: [min(data, d => d.start) || 0, max(data, d => d.end) || 0],\n      height: this._height - this._margin.top - this._margin.bottom,\n      width: this._width - this._margin.left - this._margin.right\n    };\n\n    const transform = `translate(${this._margin.left}, ${this._margin.top})`;\n\n    this._axisTest\n      .config(axisConfig)\n      .config(this._axisConfig)\n      .select(elem(\"g.d3plus-priestley-axis-test\", {parent: this._select, enter: {opacity: 0}}).node())\n      .render();\n\n    this._axis\n      .config(axisConfig)\n      .config(this._axisConfig)\n      .select(elem(\"g.d3plus-priestley-axis\", {parent: this._select, enter: {transform}, update: {transform}}).node())\n      .render();\n\n    const axisPad = this._axisTest._padding;\n\n    const xScale = this._axis._d3Scale;\n\n    const yScale = scalePoint()\n      .domain(range(0, maxLane, 1))\n      .padding(0.5)\n      .rangeRound([this._height - this._margin.bottom - this._axisTest.outerBounds().height - axisPad, this._margin.top + axisPad]);\n\n    const step = yScale.step();\n\n    this._shapes.push(new Rect()\n      .data(data)\n      .duration(this._duration)\n      .height(step >= this._padding * 2 ? step - this._padding : step > 2 ? step - 2 : step)\n      .label((d, i) => this._drawLabel(d.data, i))\n      .select(elem(\"g.d3plus-priestley-shapes\", {parent: this._select}).node())\n      .width(d => {\n        const w = Math.abs(xScale(d.end) - xScale(d.start));\n        return w > 2 ? w - 2 : w;\n      })\n      .x(d => xScale(d.start) + (xScale(d.end) - xScale(d.start)) / 2)\n      .y(d => yScale(d.lane))\n      .config(configPrep.bind(this)(this._shapeConfig, \"shape\", \"Rect\"))\n      .render());\n\n    return this;\n\n  }\n\n  /**\n      @memberof Priestley\n      @desc If *value* is specified, sets the config method for the axis and returns the current class instance. If *value* is not specified, returns the current axis configuration.\n      @param {Object} [*value*]\n      @chainable\n  */\n  axisConfig(_) {\n    return arguments.length ? (this._axisConfig = assign(this._axisConfig, _), this) : this._axisConfig;\n  }\n\n  /**\n      @memberof Priestley\n      @desc If *value* is specified, sets the end accessor to the specified function or key and returns the current class instance. If *value* is not specified, returns the current end accessor.\n      @param {Function|String} [*value*]\n      @chainable\n  */\n  end(_) {\n    if (arguments.length) {\n      if (typeof _ === \"function\") this._end = _;\n      else {\n        this._end = accessor(_);\n        if (!this._aggs[_]) this._aggs[_] = a => max(a);\n      }\n      return this;\n    }\n    else return this._end;\n  }\n\n  /**\n      @memberof Priestley\n      @desc If *value* is specified, sets the start accessor to the specified function or key and returns the current class instance. If *value* is not specified, returns the current start accessor.\n      @param {Function|String} [*value*]\n      @chainable\n  */\n  start(_) {\n    if (arguments.length) {\n      if (typeof _ === \"function\") this._start = _;\n      else {\n        this._start = accessor(_);\n        if (!this._aggs[_]) this._aggs[_] = a => min(a);\n      }\n      return this;\n    }\n    else return this._start;\n  }\n\n}\n"],"names":["Priestley","_axis","Axis","align","orient","_axisConfig","scale","_axisTest","gridSize","end","_shapeConfig","assign","ariaLabel","d","i","_drawLabel","_start","_end","start","callback","_filteredData","data","map","__d3plus__","date","id","_id","filter","sort","a","b","nestedData","_groupBy","length","_drawDepth","dataNest","nest","key","entries","values","maxLane","forEach","g","track","t","indexOf","lane","push","axisConfig","domain","min","max","height","_height","_margin","top","bottom","width","_width","left","right","transform","config","select","elem","parent","_select","enter","opacity","node","render","update","axisPad","_padding","xScale","_d3Scale","yScale","scalePoint","range","padding","rangeRound","outerBounds","step","_shapes","Rect","duration","_duration","label","w","Math","abs","x","y","configPrep","bind","_","arguments","accessor","_aggs","Viz"],"mappings":"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"}